== Bastion

=== Modules
There are two core modules which support the configuration of the Bastion VPC and the launching of the bastion instance.

==== bastion/bootstrap
Creates a subnet within the provided VPC and configures the appropriate route table/routes based on given parameters

===== Variables

- vpc_id: **(required)** ID of the VPC to target
- availability_zone: **(optional)** AZ you want to target - defaults to first available
- gateway_id: **(required)** Gateway to use for Public Route
- peering_connection_ids: **(optional)** Peering connections to create routes for


==== bastion/launch_bastion_instance
Launches an instance within the provided subnet and configures the instance and attached security group based on given parameters

===== Variables

- ami_id: **(required)** ID of AMI to use for the bastion instance
- enable_public_ip: **(optional)** enable/assign a public IP - default false
- instance_type: **(optional)** Instance Type to use for bastion instance - default t2.small
- subnet_id: **(required)** ID of the Subnet to launch bastion instance in
- user_data: **(required)** User Data to inject at launch time
- ssh_cidrs: **(required)** List of CIDRs you want to allow SSH from


=== Example template with notes

The example below can be used as a template to create your own environment specific template

* Copy and paste the following into your own terraform template.
* create a file within the same directory called user_data.yml (or you can create elsewhere and modify the path below)
* Adjust the source path for the modules as needed (relative to where you create your template)
* Substitute your values for the variables (all defined within local)
** If you don't have a VPC and/or gateway (CGW,IGW, etc), you can add the creation of it within your template
* Run
** teraform init
** terraform plan
*** review output plan
** terraform apply



[source, hcl]
----
locals {
  vpc_id="<<target VPC ID here>>"
  region="<<target REGION here>>"
  availability_zone="<<target AVAILABILITY ZONE here>>"
  //hack to fix the path for windows, theoretically this will be fixed in v 0.12 to use same convention on all OS
  module_path = "${replace(path.module, "\\", "/")}"
  local_user_data_path      = "${local.module_path}/user_data.yml"
  //Peering Connection IDs if applicable
  peering_connection_ids = ["<<Peering Connection ID 1>>","<<Peering Connection ID 2>>","<<Peering Connection ID ...>>"]
  //Ibbound CIDRs e.g. "0.0.0.0/0" is from anywhere
  inbound_ssh_cidrs = ["<<CIDRs to allow SSH from>>"]
  gateway_id = "<<Gateway ID to use for public route>>"
}

module "providers" {
  source = "../../../../modules/dark_providers"
}

provider "aws" {
  region     = "us-east-1"
}

module "bootstrap_bastion" {
  source = "../../../../modules/bastion/bootstrap"
  vpc_id = "${local.vpc_id}"
  gateway_id = "${local.gateway_id}"
  peering_connection_ids = "${local.peering_connection_ids}"
  availability_zone = "${local.availability_zone}"
}

data "template_cloudinit_config" "user_data" {
  base64_encode = false
  gzip = false
  part {
    filename     = "other.cfg"
    content_type = "text/cloud-config"
    content      = "${file("${local.local_user_data_path}")}"
  }
}

module "amazon_ami" {
  source = "../../../../modules/amis/amazon_hvm_ami"
  region = "${local.region}"
}

module "bastion_host" {
  source = "../../../../modules/bastion/launch_bastion_instance"
  ami_id = "${module.amazon_ami.id}"
  user_data = "${data.template_cloudinit_config.user_data.rendered}"
  subnet_id = "${module.bootstrap_bastion.public_subnet_id}"
  enable_public_ip = "true"
  ssh_cidrs = "${local.inbound_ssh_cidrs}"
}


----

The file you enter above for user data must follow the format as described here: https://cloudinit.readthedocs.io/en/latest/

The basic example below shows an example of adding users, running an arbitrary command, and setting the final message

[source,yml]
----
#cloud-config
users:
  - name: user-abc
    groups: [ wheel ]
    sudo: [ "ALL=(ALL) NOPASSWD:ALL" ]
    shell: /bin/bash
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCw0TgdxjmFtrnGUwyW7jWXgfHy8BNSpV3VaFtuX25VsewgL/tsY5SBM5pBkuwEpnHDNRKRRPuoL4rbAuUlg869nWGoddpYRFkDAXmWotS7q5B+tvdsZi9xlWWGzpw5HIHu2wcYCvM+mwESCOjyN8bBvof8SssoWTFdMZtyj2n0DPExkc2CjSno/InehkyRK+i2K01gSblu1hWCgM0medRrsQWLooTosMSbXwnpMCD7obszYsOpEXpIT0QaTbyqpNw5KA1Bh7GVZANguF/F6mqeU0NLnMh8lzdOVuqet1BoufLvKi3rFM17O8tJbfqsDQ+AhltBQWu9UtcFJMTyYOUE4jQRifW0mEDX1jtm6o8GblD6QA/iJw44DuhxZaEEHFpcKH57K8GIA75WunipIUG0t65UHHJyNoVhg/58/XiOZ9HMmJMq7eQmYg9NW0kcPfD+RzbTeqqpEdgihaz3GbA1B+uxVrbLCb4mbaai+RVA0DpDXr7bH/SJp8lNx9x83lnEwimT7WNxbou//JzyoO6HRX8vYpoZGGtF+Td1t2CKvQOuuqKSzCxNbBf1n1im2KyCEps7PTtf9K3tLL/3eo9vj1T3JQuebjXL3VBUADj2W0p/pgReA4L3ttSI5MsZPAJaCqR1wf8KCaHP2aAb/WhVFd9ayiAdoO1jzxWBEm8GJQ== user-abc@email.com

runcmd:
  - touch test.txt

final_message: "The system is finally up, after $UPTIME seconds"
----